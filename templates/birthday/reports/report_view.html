{% extends 'base.html' %}

{% block title %}{{ title }} | Proceed{% endblock %}

{% block extra_css %}
{% include 'components/premium_styles.html' %}
<style>
    .report-stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .report-number {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
    }

    .report-label {
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-5">
        <a href="{% url 'report_dashboard' %}" class="btn btn-sm btn-outline-light border-opacity-25 mb-3">
            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
        <h2 class="fw-bold mb-0">{{ title }}</h2>
        <p class="text-white-50 small mb-0">{{ start_date|date:"M d, Y" }} – {{ end_date|date:"M d, Y" }}</p>
    </div>
    <div class="col-md-7 text-md-end">
        <div class="d-flex gap-2 justify-content-md-end">
            <button type="button" class="btn btn-outline-info px-4 border-opacity-25" data-bs-toggle="modal"
                data-bs-target="#emailReportModal">
                <i class="bi bi-envelope me-2"></i> Email Report
            </button>
            <a href="{% url 'generate_report' %}?period={{ period }}&format=pdf&type={{ report_type }}"
                class="btn btn-premium px-4">
                <i class="bi bi-file-earmark-pdf me-2"></i> Download as PDF
            </a>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="row g-3 mb-5">
    {% if report_type == 'birthday' %}
    <div class="col-md-4">
        <div class="report-stat-card text-center">
            <div class="report-label mb-2">Total Upcoming Birthdays</div>
            <div class="report-number">{{ total_birthdays }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="report-stat-card text-center border-primary border-opacity-10">
            <div class="report-label mb-2 text-primary">Email Outreach (Period)</div>
            <div class="report-number text-primary">{{ email_sent }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="report-stat-card text-center border-success border-opacity-10">
            <div class="report-label mb-2 text-success">SMS Outreach (Period)</div>
            <div class="report-number text-success">{{ sms_sent }}</div>
        </div>
    </div>
    {% else %}
    <div class="col-md-6">
        <div class="report-stat-card text-center border-warning border-opacity-10">
            <div class="report-label mb-2 text-warning">Total Expiring Plans</div>
            <div class="report-number text-warning">{{ total_expiring }}</div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="report-stat-card text-center border-info border-opacity-10">
            <div class="report-label mb-2 text-info">Coverage Range</div>
            <div class="report-number fs-4 text-white" style="line-height: 2.2;">{{ start_date|date:"M d" }} - {{
                end_date|date:"M d, Y" }}</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Detailed Birthday Report -->
<div class="row mt-4">
    <div class="col-12">
        <div class="glass-card">
            <div
                class="p-3 border-bottom border-white border-opacity-10 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">
                    {% if report_type == 'birthday' %}
                    {% if period == 'weekly' %}Last Week's Birthday List{% else %}Monthly Birthday List{% endif %}
                    {% else %}
                    {% if period == 'weekly' %}Next Week's Expiration List{% else %}Monthly Expiration List{% endif %}
                    {% endif %}
                </h5>
                <span class="badge bg-primary bg-opacity-10 text-primary small">{{ patients|length }} Recipients</span>
            </div>
            <div class="table-responsive p-3">
                <table class="table table-custom mb-0">
                    <thead>
                        {% if report_type == 'birthday' %}
                        <tr>
                            <th class="small text-center" style="width: 50px;">#</th>
                            <th class="small">Patient Name</th>
                            <th class="small">Birthday</th>
                            <th class="small">Age</th>
                            <th class="small">Plan</th>
                            <th class="small text-center">Proceed Status</th>
                            <th class="small text-center">Email</th>
                            <th class="small text-center">SMS</th>
                        </tr>
                        {% else %}
                        <tr>
                            <th class="small text-center" style="width: 50px;">#</th>
                            <th class="small">Patient Name</th>
                            <th class="small">Enrolled</th>
                            <th class="small">Expires</th>
                            <th class="small">Plan</th>
                            <th class="small text-center">Days Left</th>
                            <th class="small text-center">Status</th>
                        </tr>
                        {% endif %}
                    </thead>
                    <tbody>
                        {% csrf_token %}
                        {% for patient in patients %}
                        {% if report_type == 'birthday' %}
                        <tr>
                            <td class="text-center text-white-50 small">{{ forloop.counter }}</td>
                            <td class="fw-bold text-white">{{ patient.first_name }} {{ patient.last_name }}</td>
                            <td class="text-white-50">
                                <span class="badge bg-white bg-opacity-10 text-white fw-normal">
                                    {{ patient.bday_this_year|date:"l, M d" }}
                                </span>
                            </td>
                            <td class="text-white">
                                {{ patient.age_turning }}
                            </td>
                            <td class="text-white-50">
                                {{ patient.membership_plan|default:"-" }}
                            </td>
                            <td class="text-center">
                                <span class="badge rounded-pill bg-{{ patient.status_class }}">
                                    {{ patient.status_label }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="form-check d-flex justify-content-center">
                                    <input {% if patient.email_done %}checked{% endif %} type="checkbox"
                                        class="form-check-input outreach-toggle" data-patient="{{ patient.id }}"
                                        data-type="Email Sent">
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check d-flex justify-content-center">
                                    <input {% if patient.sms_done %}checked{% endif %} type="checkbox"
                                        class="form-check-input outreach-toggle" data-patient="{{ patient.id }}"
                                        data-type="SMS Sent">
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td class="text-center text-white-50 small">{{ forloop.counter }}</td>
                            <td class="fw-bold text-white">{{ patient.first_name }} {{ patient.last_name }}</td>
                            <td class="text-white-50">
                                {{ patient.enrollment_date|date:"M d, Y" }}
                            </td>
                            <td class="text-white">
                                <span class="badge bg-white bg-opacity-10 text-white fw-normal">
                                    {{ patient.expiry_date|date:"l, M d" }}
                                </span>
                            </td>
                            <td class="text-white-50">
                                {{ patient.membership_plan|default:"-" }}
                            </td>
                            <td class="text-center text-{{ patient.status_class }}">
                                {{ patient.days_until_expiry }} Days
                            </td>
                            <td class="text-center">
                                <span class="badge rounded-pill bg-{{ patient.status_class }}">
                                    {{ patient.status_label }}
                                </span>
                            </td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-white-50 opacity-50">No patients found in this
                                period.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Email Report Modal -->
<div class="modal fade" id="emailReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-white border-opacity-10">
            <div class="modal-header border-white border-opacity-10">
                <h5 class="modal-title fw-bold text-white">Send Report via Email</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4">
                    <label class="form-label text-white-50 small text-uppercase fw-bold">Recipient Email</label>
                    <input type="email" id="targetEmail"
                        class="form-control bg-white bg-opacity-10 border-white border-opacity-10 text-white"
                        placeholder="e.g., manager@example.com" value="{{ recipient_email|default:'' }}">
                </div>

                <div class="email-preview-scroll"
                    style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                    <div
                        class="text-white-50 small text-uppercase fw-bold mb-3 border-bottom border-white border-opacity-10 pb-2">
                        Email Preview</div>

                    <div class="text-white small mb-3" style="font-size: 0.9rem;">
                        <strong>Hi Ma’am,</strong><br><br>
                        {% if report_type == 'birthday' %}
                        Sharing the birthday greeting summary for last week ({{ start_date|date:"F d" }} – {{ end_date|date:"F d, Y" }}). 
                        During this period, we sent birthday greetings to the following
                        patients on behalf of the <strong>Office of Keerthi Senthil DDS, MS</strong>.
                        {% else %}
                        Sharing the plan expiration summary for next week ({{ start_date|date:"F d" }} – {{ end_date|date:"F d, Y" }}). 
                        The following Proceed plans are set to expire during this period.
                        {% endif %}
                    </div>

                    <div class="p-2 mb-3 bg-white bg-opacity-5 rounded text-white-50 small text-center italic border border-white border-opacity-5"
                        style="border-style: dashed !important;">
                        <i class="bi bi-table me-1"></i> [{% if report_type == 'birthday' %}Birthday List{% else %}
                        Expiration List{% endif %} Table: {{ patients|length }} Recipients]
                    </div>

                    <div class="text-white small mb-4">Please review this report at your convenience.</div>

                    <div class="text-white-50 pt-3"
                        style="font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div class="text-white fw-bold">Best Regards,<br><br>Bijoy C.V.</div>
                        <div class="text-primary fw-bold">American Dental Software</div>
                        <div>A Siva Solutions Inc. Company</div>
                        <div class="text-info opacity-75">www.AmericanDentalSoftware.com</div>
                        <div class="text-info opacity-75 mb-2">www.SivaSolutions.com</div>

                        <div class="fw-bold mt-2 text-white opacity-75">Tel or Fax</div>
                        <div class="opacity-75">1.877.SIVA SALES (1.877.748.2725)</div>
                        <div class="opacity-75">1.877.SIVA SUPPORT (1.877.748.2787)</div>
                        <div class="opacity-75 mb-2">909.992.0658</div>

                        <div class="fw-bold mt-2 text-white opacity-75">Mailing Address</div>
                        <div class="opacity-75">72027 Desert Dr., Rancho Mirage, CA 92270</div>
                    </div>

                    <div
                        style="margin-top: 20px; font-size: 0.65rem; color: rgba(255,255,255,0.25); font-style: italic; line-height: 1.3;">
                        Confidentiality Note: This message is intended only for the named recipient and may contain
                        confidential...
                    </div>
                </div>
            </div>
            <div class="modal-footer border-white border-opacity-10 p-3">
                <button type="button" class="btn btn-outline-light border-opacity-25 px-4"
                    data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-premium px-4" id="confirmSendEmail">
                    <i class="bi bi-send me-2"></i> Send Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="emailToast" class="toast align-items-center text-white bg-primary border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">
                Processing...
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    .form-check-input {
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        cursor: pointer;
    }

    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Handle Outreach Toggles
        $('.outreach-toggle').change(function () {
            const patientId = $(this).data('patient');
            const activityType = $(this).data('type');
            const isChecked = $(this).is(':checked');
            const csrftoken = $('[name=csrfmiddlewaretoken]').val();

            $.ajax({
                url: "{% url 'mark_outreach_status' %}",
                method: 'POST',
                data: {
                    'patient_id': patientId,
                    'activity_type': activityType,
                    'checked': isChecked,
                    'csrfmiddlewaretoken': csrftoken
                },
                success: function (response) {
                    console.log('Outreach status updated successfully');
                },
                error: function () {
                    alert('Error updating outreach status.');
                }
            });
        });

        // Handle Email Report Button (Now inside Modal)
        $('#confirmSendEmail').click(function () {
            const btn = $(this);
            const originalHtml = btn.html();
            const targetEmail = $('#targetEmail').val();
            const period = "{{ period }}";
            const toastEl = document.getElementById('emailToast');
            const toast = new bootstrap.Toast(toastEl);
            const toastMsg = $('#toastMessage');

            if (!targetEmail || !targetEmail.includes('@')) {
                alert('Please enter a valid email address.');
                return;
            }

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span> Sending...');

            $.ajax({
                url: "{% url 'email_report_trigger' %}",
                data: {
                    'period': period,
                    'email': targetEmail,
                    'type': '{{ report_type }}'
                },
                success: function (response) {
                    // Close Modal
                    bootstrap.Modal.getInstance(document.getElementById('emailReportModal')).hide();

                    toastMsg.text(response.message || 'Email sent successfully!');
                    $(toastEl).removeClass('bg-danger bg-primary').addClass('bg-success');
                    toast.show();
                },
                error: function () {
                    toastMsg.text('Failed to send email. Please try again.');
                    $(toastEl).removeClass('bg-success bg-primary').addClass('bg-danger');
                    toast.show();
                },
                complete: function () {
                    btn.prop('disabled', false).html(originalHtml);
                }
            });
        });
    });
</script>
{% endblock %}