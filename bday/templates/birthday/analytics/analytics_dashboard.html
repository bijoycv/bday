{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Proceed Dental{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, rgba(30, 30, 40, 0.9) 0%, rgba(20, 20, 30, 0.95) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .stat-card .icon-box {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card .stat-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
    }

    .plan-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.1);
    }

    .plan-bar .bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .birthday-item {
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .birthday-item:hover {
        background: rgba(99, 102, 241, 0.15);
    }

    .activity-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .chart-container {
        height: 200px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">
                <i class="bi bi-graph-up-arrow text-primary me-2"></i>Analytics Dashboard -
            </h2>
            <p class="text-white-50 mb-0">Real-time insights into your Proceed Dental Saving Plan</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'patient_list' %}" class="btn btn-outline-light rounded-pill">
                <i class="bi bi-people me-1"></i>View Patients
            </a>
            <a href="{% url 'campaign_list' %}" class="btn btn-primary rounded-pill">
                <i class="bi bi-megaphone me-1"></i>Campaigns
            </a>
        </div>
    </div>

    <!-- Top Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-value text-primary">{{ total_patients }}</div>
                        <div class="stat-label">Total Patients</div>
                    </div>
                    <div class="icon-box bg-primary bg-opacity-25 text-primary">
                        <i class="bi bi-people-fill"></i>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-3 small">
                    <span class="text-success">
                        <i class="bi bi-check-circle me-1"></i>{{ proceed_patients }} Proceed
                    </span>
                    <span class="text-white-50">
                        <i class="bi bi-circle me-1"></i>{{ regular_patients }} Regular
                    </span>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-value text-success">{{ active_count }}</div>
                        <div class="stat-label">Active Members</div>
                    </div>
                    <div class="icon-box bg-success bg-opacity-25 text-success">
                        <i class="bi bi-shield-check"></i>
                    </div>
                </div>
                <div class="mt-3 plan-bar">
                    {% widthratio active_count proceed_patients 100 as active_pct %}
                    <div class="bar-fill bg-success" style="width: {{ active_pct|default:0 }}%;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-value text-warning">{{ expiring_soon_count }}</div>
                        <div class="stat-label">Expiring Soon</div>
                    </div>
                    <div class="icon-box bg-warning bg-opacity-25 text-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="mt-3 small text-white-50">
                    <i class="bi bi-info-circle me-1"></i>Within 30 days
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-value text-danger">{{ expired_count }}</div>
                        <div class="stat-label">Expired</div>
                    </div>
                    <div class="icon-box bg-danger bg-opacity-25 text-danger">
                        <i class="bi bi-x-circle"></i>
                    </div>
                </div>
                <div class="mt-3 small text-white-50">
                    <i class="bi bi-arrow-repeat me-1"></i>Needs renewal
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Plan Distribution -->
        <div class="col-lg-8">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart text-primary me-2"></i>Plan Distribution
                    </h5>
                    <span class="badge bg-primary">{{ proceed_patients }} Members</span>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Gold -->
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-2"
                                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #FFD700, #DAA520);">
                                    <i class="bi bi-star-fill text-dark" style="font-size: 2rem;"></i>
                                </div>
                                <h3 class="fw-bold mb-0 text-warning">{{ gold_count }}</h3>
                                <div class="text-white-50">Gold Members</div>
                            </div>
                            <div class="plan-bar">
                                {% widthratio gold_count proceed_patients 100 as gold_pct %}
                                <div class="bar-fill"
                                    style="width: {{ gold_pct|default:0 }}%; background: linear-gradient(90deg, #FFD700, #DAA520);">
                                </div>
                            </div>
                            <div class="text-center small text-white-50 mt-1">{{ gold_pct|default:0 }}%</div>
                        </div>

                        <!-- Silver -->
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-2"
                                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #C0C0C0, #A8A8A8);">
                                    <i class="bi bi-gem text-dark" style="font-size: 2rem;"></i>
                                </div>
                                <h3 class="fw-bold mb-0" style="color: #C0C0C0;">{{ silver_count }}</h3>
                                <div class="text-white-50">Silver Members</div>
                            </div>
                            <div class="plan-bar">
                                {% widthratio silver_count proceed_patients 100 as silver_pct %}
                                <div class="bar-fill"
                                    style="width: {{ silver_pct|default:0 }}%; background: linear-gradient(90deg, #C0C0C0, #A8A8A8);">
                                </div>
                            </div>
                            <div class="text-center small text-white-50 mt-1">{{ silver_pct|default:0 }}%</div>
                        </div>

                        <!-- Bronze -->
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-2"
                                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #CD7F32, #B87333);">
                                    <i class="bi bi-award text-dark" style="font-size: 2rem;"></i>
                                </div>
                                <h3 class="fw-bold mb-0" style="color: #CD7F32;">{{ bronze_count }}</h3>
                                <div class="text-white-50">Bronze Members</div>
                            </div>
                            <div class="plan-bar">
                                {% widthratio bronze_count proceed_patients 100 as bronze_pct %}
                                <div class="bar-fill"
                                    style="width: {{ bronze_pct|default:0 }}%; background: linear-gradient(90deg, #CD7F32, #B87333);">
                                </div>
                            </div>
                            <div class="text-center small text-white-50 mt-1">{{ bronze_pct|default:0 }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Birthdays -->
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-cake2 text-pink me-2" style="color: #ec4899;"></i>Today's Birthdays
                    </h5>
                    <span class="badge" style="background: #ec4899;">{{ todays_birthdays.count }}</span>
                </div>
                <div class="card-body">
                    {% if todays_birthdays %}
                    {% for patient in todays_birthdays %}
                    <div class="birthday-item d-flex align-items-center">
                        <div class="me-3" style="font-size: 1.5rem;">ðŸŽ‚</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ patient.first_name }} {{ patient.last_name }}</div>
                            <div class="small text-white-50">
                                {% if patient.membership_plan %}
                                <span class="badge bg-{{ patient.membership_plan|lower }} me-1">{{
                                    patient.membership_plan }}</span>
                                {% endif %}
                                {{ patient.email }}
                            </div>
                        </div>
                        <a href="{% url 'patient_detail' patient.pk %}"
                            class="btn btn-sm btn-outline-light rounded-pill">
                            <i class="bi bi-send"></i>
                        </a>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4 text-white-50">
                        <i class="bi bi-calendar-check d-block mb-2" style="font-size: 2rem;"></i>
                        No birthdays today
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row -->
    <div class="row g-4 mt-2">
        <!-- 30-Day Activity -->
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-activity text-info me-2"></i>30-Day Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(16, 185, 129, 0.1);">
                                <div class="h3 fw-bold text-success mb-0">{{ upgrades }}</div>
                                <div class="small text-white-50">Upgrades</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(239, 68, 68, 0.1);">
                                <div class="h3 fw-bold text-danger mb-0">{{ downgrades }}</div>
                                <div class="small text-white-50">Downgrades</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(99, 102, 241, 0.1);">
                                <div class="h3 fw-bold text-primary mb-0">{{ renewals }}</div>
                                <div class="small text-white-50">Renewals</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Stats -->
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-megaphone text-warning me-2"></i>Campaign Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="p-3 rounded-3" style="background: rgba(245, 158, 11, 0.1);">
                                <div class="h3 fw-bold text-warning mb-0">{{ active_campaigns }}</div>
                                <div class="small text-white-50">Active Campaigns</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-3" style="background: rgba(99, 102, 241, 0.1);">
                                <div class="h3 fw-bold text-primary mb-0">{{ total_campaign_sends }}</div>
                                <div class="small text-white-50">Total Messages Sent</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'campaign_list' %}" class="btn btn-outline-warning btn-sm rounded-pill">
                            View All Campaigns <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history text-success me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_patients %}
                    {% for patient in recent_patients %}
                    <div class="activity-item d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ patient.first_name }} {{ patient.last_name }}</div>
                            <div class="small text-white-50">Updated {{ patient.updated_at|timesince }} ago</div>
                        </div>
                        <a href="{% url 'patient_detail' patient.pk %}" class="text-white-50">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4 text-white-50">
                        No recent activity
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning text-primary me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{% url 'patient_list' %}?type=Proceed&status=expiring"
                                class="btn btn-outline-warning w-100 py-3">
                                <i class="bi bi-hourglass-split d-block mb-1" style="font-size: 1.5rem;"></i>
                                Expiring Memberships
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'report_dashboard' %}?type=birthday&range=weekly"
                                class="btn btn-outline-pink w-100 py-3" style="border-color: #ec4899; color: #ec4899;">
                                <i class="bi bi-cake2 d-block mb-1" style="font-size: 1.5rem;"></i>
                                Birthday Reports
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'campaign_create' %}" class="btn btn-outline-success w-100 py-3">
                                <i class="bi bi-megaphone d-block mb-1" style="font-size: 1.5rem;"></i>
                                New Campaign
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'patient_create' %}" class="btn btn-outline-primary w-100 py-3">
                                <i class="bi bi-person-plus d-block mb-1" style="font-size: 1.5rem;"></i>
                                Add Patient
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}