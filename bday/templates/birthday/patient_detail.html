{% extends 'base.html' %}

{% block title %}Patient Details | Proceed{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="fw-bold mb-0">Patient Profile</h2>
                    <p class="text-white-50 mb-0">View complete details for
                        {{ patient.first_name }} {{ patient.last_name }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'patient_update' pk=patient.pk %}" class="btn btn-premium">
                        <i class="bi bi-pencil"></i> Edit Details
                    </a>
                </div>
            </div>
            <div>
                <a href="{% url 'patient_list' %}" class="btn btn-sm btn-outline-light border-opacity-25 px-3">
                    <i class="bi bi-arrow-left me-1"></i> Back to List
                </a>
            </div>
        </div>

        <div class="row g-4">
            <!-- Main Info Card -->
            <div class="col-md-4">
                <div class="glass-card p-4 text-center h-100">
                    <div class="avatar-circle mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;">
                        {{ patient.first_name|slice:":1" }}{{ patient.last_name|slice:":1" }}
                    </div>
                    <h3 class="fw-bold mb-1">{{ patient.first_name }} {{ patient.middle_name|default:"" }}
                        {{ patient.last_name }}</h3>
                    <p class="text-muted small mb-3">Added on {{ patient.created_at|date:"M d, Y" }}</p>

                    <div class="d-flex gap-2 justify-content-center mb-3">
                        <div
                            class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25 rounded-pill px-3 py-2">
                            {{ patient.patient_type }}
                        </div>
                        {% if patient.membership_plan %}
                        {% if patient.membership_plan == 'Gold' %}
                        <div class="badge badge-gold rounded-pill px-3 py-2 fw-bold">Gold</div>
                        {% elif patient.membership_plan == 'Silver' %}
                        <div class="badge badge-silver rounded-pill px-3 py-2 fw-bold">Silver</div>
                        {% elif patient.membership_plan == 'Bronze' %}
                        <div class="badge badge-bronze rounded-pill px-3 py-2 fw-bold">Bronze</div>
                        {% else %}
                        <div
                            class="badge bg-info bg-opacity-25 text-info border border-info border-opacity-25 rounded-pill px-3 py-2">
                            {{ patient.membership_plan }}
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="border-top border-secondary border-opacity-25 pt-3 mt-3 text-start">
                        <div class="mb-2">
                            <small
                                class="{% if patient.dob|date:'m-d' == today|date:'m-d' %}text-danger fw-bold pulse-animation{% else %}text-muted{% endif %} d-block text-uppercase"
                                style="font-size: 0.7rem;">
                                <i class="bi bi-balloon-fill me-1"></i>Date of Birth
                            </small>
                            <span
                                class="{% if patient.dob|date:'m-d' == today|date:'m-d' %}text-danger fw-bold fs-5{% else %}fw-bold{% endif %}">
                                {{ patient.dob|date:"F j, Y" }}
                            </span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Age</small>
                            <span class="fw-medium">{{ patient.dob|timesince }} old</span>
                        </div>
                        {% if patient.gender %}
                        <div class="mb-2">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Gender</small>
                            <span class="fw-medium">{{ patient.gender }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Contact & Details -->
            <div class="col-md-8">
                <div class="glass-card p-4 h-100">
                    <!-- Quick Stats Grid -->
                    <div class="row g-3 mb-4">
                        <!-- Contact Info -->
                        <div class="col-md-8">
                            <div class="p-3 rounded h-100 border border-white border-opacity-10"
                                style="background: rgba(255, 255, 255, 0.03);">
                                <h6 class="fw-bold text-white mb-3 d-flex align-items-center">
                                    <i class="bi bi-person-lines-fill text-primary me-2"></i> Contact & Location
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <div
                                                class="icon-square bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                                <i class="bi bi-envelope"></i>
                                            </div>
                                            <div style="min-width: 0;">
                                                <small class="text-muted d-block uppercase-label">Email</small>
                                                <div class="text-white text-truncate" title="{{ patient.email }}">
                                                    {{ patient.email }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <div
                                                class="icon-square bg-success bg-opacity-10 text-success rounded p-2 me-3">
                                                <i class="bi bi-telephone"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block uppercase-label">Phone</small>
                                                <div class="text-white">{{ patient.phone }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <div
                                                class="icon-square {% if patient.accepts_marketing %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 text-{% if patient.accepts_marketing %}success{% else %}danger{% endif %} rounded p-2 me-3">
                                                <i
                                                    class="bi {% if patient.accepts_marketing %}bi-check-circle{% else %}bi-x-circle{% endif %}"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block uppercase-label">Communications</small>
                                                <div class="text-white">
                                                    {% if patient.accepts_marketing %}
                                                    Enabled
                                                    {% else %}
                                                    Disabled
                                                    <small class="text-white-50 d-block"
                                                        style="font-size: 0.65rem;">Reason: {{
                                                        patient.unsubscribe_reason }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 border-top border-white border-opacity-10 pt-3 mt-1">
                                        <div class="d-flex align-items-start">
                                            <div class="icon-square bg-info bg-opacity-10 text-info rounded p-2 me-3">
                                                <i class="bi bi-geo-alt"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block uppercase-label">Mailing
                                                    Address</small>
                                                <div class="fw-medium text-white">{{ patient.address|default:"-" }}
                                                </div>
                                                <div class="text-white-50 small">{{ patient.city }}, {{ patient.state }}
                                                    {{ patient.zip_code }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Membership Info -->
                        <div class="col-md-4">
                            <div class="p-3 rounded h-100 border border-white border-opacity-10"
                                style="background: rgba(255, 255, 255, 0.03);">
                                <h6 class="fw-bold text-white mb-3 d-flex align-items-center">
                                    <i class="bi bi-card-checklist text-warning me-2"></i> Plan Status
                                </h6>
                                <div class="mb-3">
                                    <small class="text-muted d-block uppercase-label">Enrolled On</small>
                                    <div class="fw-bold text-white fs-5">
                                        {{ patient.enrollment_date|date:"M j, Y"|default:"-" }}</div>
                                </div>
                                <div>
                                    <small class="text-muted d-block uppercase-label mb-1">Current Term</small>
                                    {% if patient.enrollment_date %}
                                    <div class="progress mb-2"
                                        style="height: 6px; background-color: rgba(255,255,255,0.1);">
                                        <div class="progress-bar bg-{{ patient.plan_progress.status }}"
                                            role="progressbar" style="width: {{ patient.plan_progress.percentage }}%">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between small" style="font-size: 0.7rem;">
                                        <span class="text-white-50">Expires</span>
                                        <span class="text-{{ patient.plan_progress.status }} fw-bold">
                                            {{ patient.plan_progress.expiry_date|date:"M j, Y" }}</span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted small">Not Enrolled</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if patient.notes %}
                    <div class="mb-4">
                        <div class="p-3 rounded bg-warning bg-opacity-10 border border-warning border-opacity-25">
                            <h6 class="text-warning small text-uppercase fw-bold mb-2"><i
                                    class="bi bi-sticky me-2"></i>Notes</h6>
                            <p class="text-white-50 small mb-0">{{ patient.notes }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Recent Activity -->
                    <div>
                        <h6 class="fw-bold text-white mb-3 border-bottom border-white border-opacity-10 pb-2">
                            Recent Activity Log
                        </h6>
                        <div class="activity-timeline" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                            {% for activity in patient.activities.all %}
                            <div class="activity-item d-flex gap-3 mb-0 cursor-pointer p-3 rounded hover-bg-white-5 border-bottom border-white border-opacity-5"
                                data-bs-toggle="modal" data-bs-target="#activityDetailModal"
                                data-type="{{ activity.activity_type }}"
                                data-date="{{ activity.created_at|date:'M d, Y H:i' }}"
                                data-desc="{{ activity.description }}"
                                data-content="{{ activity.full_content|default:'' }}">
                                <div class="activity-icon-container">
                                    <div class="activity-dot bg-primary"></div>
                                    <div class="activity-line"></div>
                                </div>
                                <div class="activity-content">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-bold text-white" style="font-size: 0.9rem;">
                                            {{ activity.activity_type }}</span>
                                        <small class="text-white-50" style="font-size: 0.75rem;">
                                            {{ activity.created_at|date:"M d, H:i" }}</small>
                                    </div>
                                    <p class="text-secondary small mb-0 text-truncate">{{ activity.description }}</p>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 text-white-50">
                                <i class="bi bi-clock-history display-6 mb-2 d-block opacity-50"></i>
                                <span class="small">No recent activity recorded.</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Detail Modal -->
<div class="modal fade" id="activityDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-secondary border-opacity-25 shadow-lg">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title fw-bold text-white" id="modal-activity-type">Activity Detail</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-white">
                <div class="mb-3">
                    <small class="text-muted text-uppercase d-block mb-1" style="font-size: 0.7rem;">Time</small>
                    <div id="modal-activity-date" class="fw-medium"></div>
                </div>
                <div class="mb-3">
                    <small class="text-muted text-uppercase d-block mb-1" style="font-size: 0.7rem;">Description</small>
                    <div id="modal-activity-desc" class="text-white-50"></div>
                </div>
                <div id="modal-content-section" style="display: none;">
                    <small class="text-muted text-uppercase d-block mb-1" style="font-size: 0.7rem;">Content</small>
                    <div class="glass-card p-3 bg-dark bg-opacity-50 border-secondary border-opacity-25"
                        id="modal-activity-content" style="font-family: inherit;"></div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-premium w-100" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const activityModal = document.getElementById('activityDetailModal');
        if (activityModal) {
            activityModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const type = button.getAttribute('data-type');
                const date = button.getAttribute('data-date');
                const desc = button.getAttribute('data-desc');
                const content = button.getAttribute('data-content');

                document.getElementById('modal-activity-type').textContent = type;
                document.getElementById('modal-activity-date').textContent = date;
                document.getElementById('modal-activity-desc').textContent = desc;

                const contentSection = document.getElementById('modal-content-section');
                const contentDiv = document.getElementById('modal-activity-content');

                if (content && content.trim() !== '') {
                    contentDiv.innerHTML = content;
                    contentSection.style.display = 'block';
                } else {
                    contentSection.style.display = 'none';
                }
            });
        }
    });
</script>

<style>
    .uppercase-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .activity-timeline {
        position: relative;
    }

    .activity-icon-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 12px;
    }

    .activity-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        z-index: 1;
        margin-top: 5px;
    }

    .activity-line {
        width: 2px;
        background: rgba(255, 255, 255, 0.1);
        flex-grow: 1;
        margin-top: 2px;
    }

    .activity-item:last-child .activity-line {
        display: none;
    }

    .activity-content {
        flex-grow: 1;
    }

    .x-small {
        font-size: 0.7rem;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .hover-bg-white-5:hover {
        background: rgba(255, 255, 255, 0.05) !important;
        transition: background 0.2s ease;
    }

    .pulse-animation {
        animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
        0% {
            transform: scale(0.95);
            text-shadow: 0 0 0 rgba(244, 63, 94, 0.7);
        }

        70% {
            transform: scale(1);
            text-shadow: 0 0 10px rgba(244, 63, 94, 0.5);
        }

        100% {
            transform: scale(0.95);
            text-shadow: 0 0 0 rgba(244, 63, 94, 0);
        }
    }
</style>
{% endblock %}